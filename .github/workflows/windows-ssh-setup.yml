name: Secure Windows SSH

on:
  workflow_dispatch:

jobs:
  setup-ssh:
    runs-on: windows-latest
    steps:
      - name: Generate Secure Credentials
        run: |
          # 生成随机密码
          $pass = -join ((1..20) | ForEach-Object { (65..90) + (97..122) + (48..57) | Get-Random | ForEach-Object {[char]$_} })
          Write-Host "::add-mask::$pass"
          echo "SSH_PASS=$pass" >> $env:GITHUB_ENV
          echo "USER_NAME=remote_admin" >> $env:GITHUB_ENV
        shell: powershell

      - name: Setup OpenSSH & Create User
        run: |
          Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
          Start-Service sshd
          
          # 创建用户使用环境变量，此时日志会显示 ***
          $securePass = ConvertTo-SecureString $env:SSH_PASS -AsPlainText -Force
          New-LocalUser -Name $env:USER_NAME -Password $securePass -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $env:USER_NAME
        shell: powershell

      - name: Configure SSH Keys
        env:
          PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }} # 建议存入 Secrets
        run: |
          $path = "C:\ProgramData\ssh\administrators_authorized_keys"
          $env:PUBLIC_KEY | Out-File -FilePath $path -Encoding ascii
          # 设置权限 (省略重复的 ACL 代码...)
          Restart-Service sshd
        shell: powershell

      - name: Show Connection (Safe)
        run: |
          Write-Host "=========================================="
          Write-Host "User:     $env:USER_NAME"
          # 这里即使打印 $env:SSH_PASS，GitHub 日志也会显示 ***
          Write-Host "Password: $env:SSH_PASS" 
          Write-Host "SSH Port: 6003"
          Write-Host "=========================================="
        shell: powershell