name: Windows SSH Setup

on:
  workflow_dispatch:

jobs:
  setup-ssh:
    runs-on: windows-latest
    
    steps:
      - name: Setup OpenSSH
        env:
          SSH_PUBLIC_KEYS: ${{ secrets.SSH_PUBLIC_KEYS }}
          FRP_TOKEN: ${{ secrets.FRP_TOKEN }}
        run: |
          # Install OpenSSH Server
          Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
          
          # Start service
          Start-Service sshd
          Set-Service -Name sshd -StartupType 'Automatic'
          
          # Configure firewall
          if (!(Get-NetFirewallRule -Name "OpenSSH-Server-In-TCP" -ErrorAction SilentlyContinue)) {
              New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
          }
          
          # Configure SSH
          $sshdConfig = "C:\ProgramData\ssh\sshd_config"
          Add-Content -Path $sshdConfig -Value "`nPubkeyAuthentication yes"
          Add-Content -Path $sshdConfig -Value "PasswordAuthentication no"
          
          # Add SSH keys
          $sshDir = "$env:USERPROFILE\.ssh"
          New-Item -ItemType Directory -Path $sshDir -Force | Out-Null
          
          # Write keys properly
          $env:SSH_PUBLIC_KEYS | Set-Content -Path "$sshDir\authorized_keys" -Encoding UTF8
          
          # Critical: Windows OpenSSH requires specific permissions
          # Remove inheritance and set explicit permissions
          $acl = Get-Acl "$sshDir\authorized_keys"
          $acl.SetAccessRuleProtection($true, $false)
          $acl.Access | ForEach-Object { $acl.RemoveAccessRule($_) }
          
          # Add only necessary permissions
          $rule1 = New-Object System.Security.AccessControl.FileSystemAccessRule($env:USERNAME, "Read", "Allow")
          $rule2 = New-Object System.Security.AccessControl.FileSystemAccessRule("SYSTEM", "FullControl", "Allow")
          $acl.AddAccessRule($rule1)
          $acl.AddAccessRule($rule2)
          Set-Acl "$sshDir\authorized_keys" $acl
          
          # Restart SSH service
          Restart-Service sshd
          
          Write-Host "SSH setup complete"
        shell: powershell
      
      - name: Install FRP Tunnel
        env:
          FRP_TOKEN: ${{ secrets.FRP_TOKEN }}
        run: |
          pip install frp-tunnel
          frp-tunnel client --server 34.102.78.219 --token $env:FRP_TOKEN --port 6003
          Write-Host "FRP Tunnel connected on port 6003"
        shell: powershell
      
      - name: Show connection info
        run: |
          Write-Host "Connection ready!"
          Write-Host "Username: $env:USERNAME"
          Write-Host "SSH from server: ssh -p 6003 $env:USERNAME@34.102.78.219"
          Write-Host ""
          Write-Host "Checking SSH service..."
          Get-Service sshd
          Write-Host ""
          Write-Host "Checking authorized_keys..."
          Get-Content "$env:USERPROFILE\.ssh\authorized_keys"
          Write-Host ""
          Write-Host "Testing local SSH..."
          ssh -o StrictHostKeyChecking=no localhost "echo Local SSH works!"
          Write-Host ""
          Write-Host "Keeping connection alive for 5 minutes..."
        shell: powershell
      
      - name: Keep alive for 5 minutes
        run: |
          for ($i=1; $i -le 30; $i++) {
            Write-Host "[$i/30] Connection active..."
            Start-Sleep -Seconds 10
          }
        shell: powershell
