name: Windows SSH Setup (Final Password Fix)

on:
  push:
    branches:
      - main

env:
  SSH_USER: "admin"
  # 使用一个绝对合规的长密码
  SSH_PASS: "pb@1122332211"
  DEFAULT_DIR: "D:/projects"
  FRP_PORT: "6003"
  FRP_SERVER: "34.102.78.219"

jobs:
  setup-ssh:
    runs-on: windows-latest
    
    steps:
      - name: Force Disable Password Policy and Create User
        run: |
          # 1. 强制关闭 Windows 密码复杂度要求 (核心修复)
          secedit /export /cfg config.inf
          (Get-Content config.inf) -replace 'PasswordComplexity = 1', 'PasswordComplexity = 0' | Set-Content config.inf
          secedit /configure /db $env:temp\temp.sdb /cfg config.inf /areas SECURITYPOLICY
          
          # 2. 安装 SSH 服务
          Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
          Start-Service sshd
          Set-Service -Name sshd -StartupType 'Automatic'

          # 3. 创建用户 (带错误处理)
          $Password = ConvertTo-SecureString $env:SSH_PASS -AsPlainText -Force
          try {
              if (Get-LocalUser -Name $env:SSH_USER -ErrorAction SilentlyContinue) {
                  Remove-LocalUser -Name $env:SSH_USER
              }
              New-LocalUser -Name $env:SSH_USER -Password $Password -AccountNeverExpires -Description "SSH User"
              Add-LocalGroupMember -Group "Administrators" -Member $env:SSH_USER
              Write-Host "User created successfully!"
          } catch {
              Write-Error "User creation failed: $_"
              exit 1
          }

          # 4. 配置 SSHD (开启密码，禁用公钥)
          $configPath = "C:\ProgramData\ssh\sshd_config"
          $content = Get-Content $configPath
          $content = $content -replace '^#?PasswordAuthentication.*', 'PasswordAuthentication yes'
          $content = $content -replace '^#?PubkeyAuthentication.*', 'PubkeyAuthentication no'
          $content = $content -replace '^#?PermitRootLogin.*', 'PermitRootLogin yes'
          $content = $content -replace 'Match Group administrators', '#Match Group administrators'
          $content = $content -replace 'AuthorizedKeysFile __PROGRAMDATA__/ssh/administrators_authorized_keys', '#AuthorizedKeysFile __PROGRAMDATA__/ssh/administrators_authorized_keys'
          $content | Set-Content $configPath -Encoding ascii

          # 5. 设置默认目录 D:/projects
          if (!(Test-Path $env:DEFAULT_DIR)) { New-Item -ItemType Directory -Force -Path $env:DEFAULT_DIR }
          New-ItemProperty -Path "HKLM:\SOFTWARE\OpenSSH" -Name "DefaultShell" -Value "powershell.exe" -PropertyType String -Force
          New-ItemProperty -Path "HKLM:\SOFTWARE\OpenSSH" -Name "DefaultShellCommandOption" -Value "/K cd /d $env:DEFAULT_DIR" -PropertyType String -Force

          Restart-Service sshd
        shell: powershell

      - name: Launch FRP
        env:
          FRP_TOKEN: ${{ secrets.FRP_TOKEN }}
        run: |
          pip install frp-tunnel
          $frpArgs = "client --server $env:FRP_SERVER --token $env:FRP_TOKEN --port $env:FRP_PORT"
          Start-Process "frp-tunnel" -ArgumentList $frpArgs -NoNewWindow
          Start-Sleep -Seconds 10
        shell: powershell

      - name: Connection Info
        run: |
          Write-Host "------------------------------------------------"
          Write-Host "SSH Ready: ssh ${env:SSH_USER}@${env:FRP_SERVER} -p ${env:FRP_PORT}"
          Write-Host "Password: ${env:SSH_PASS}"
          Write-Host "------------------------------------------------"
        shell: powershell

      - name: Keep Alive
        run: |
          $sw = [System.Diagnostics.Stopwatch]::StartNew()
          while ($sw.Elapsed.TotalHours -lt 6) {
            Start-Sleep -Seconds 60
          }
        shell: powershell